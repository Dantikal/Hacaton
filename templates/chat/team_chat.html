{% extends 'base.html' %}
{% load static %}

{% block title %}Чат команды {{ team.name }} - Хакатон{% endblock %}

{% block content %}
<meta name="current-user" content="{{ user.username }}">

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">
                            <i class="fas fa-comments"></i> Чат команды "{{ team.name }}"
                        </h4>
                        <small>Участники: {{ team.member_count }}</small>
                    </div>
                    <a href="{% url 'teams:detail' team.pk %}" class="btn btn-light">
                        <i class="fas fa-arrow-left"></i> К команде
                    </a>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div id="chat-container" class="chat-container" data-team-id="{{ team.pk }}">
                    <div id="messages-container">
                        {% for message in messages %}
                            <div class="chat-message {% if message.author == user %}own{% else %}other{% endif %}">
                                <div class="message-author">{{ message.author.get_full_name|default:message.author.username }}</div>
                                <div class="message-content">{{ message.content|linebreaksbr }}</div>
                                <div class="message-time">{{ message.created_at|date:"H:i" }}</div>
                            </div>
                        {% empty %}
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Пока нет сообщений. Начните общение!</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="border-top p-3">
                    <form id="message-form" data-team-id="{{ team.pk }}">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" id="message-content" class="form-control" 
                                   placeholder="Введите сообщение..." maxlength="1000" required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Отправить
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.chat-container {
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
}

.chat-message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 0.75rem;
    max-width: 80%;
    word-wrap: break-word;
}

.chat-message.own {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.chat-message.other {
    background-color: #e9ecef;
    color: #212529;
}

.chat-message.own .message-author {
    color: rgba(255, 255, 255, 0.8);
}

.chat-message.other .message-author {
    color: #007bff;
    font-weight: bold;
}

.message-time {
    font-size: 0.75rem;
    opacity: 0.7;
    margin-top: 0.25rem;
}

.message-content {
    margin: 0.25rem 0;
    line-height: 1.4;
}

/* Стили для прокрутки */
.chat-container::-webkit-scrollbar {
    width: 6px;
}

.chat-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.chat-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Анимация появления новых сообщений */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-message {
    animation: slideInUp 0.3s ease-out;
}

/* Адаптивность */
@media (max-width: 768px) {
    .chat-message {
        max-width: 95%;
    }
    
    .chat-container {
        height: 400px;
    }
}
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-content');
    
    // Прокрутка вниз при загрузке
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Функция для добавления нового сообщения
    function addMessage(message) {
        // Проверяем, нет ли уже такого сообщения
        const existingMessages = messagesContainer.querySelectorAll('.chat-message');
        for (let existingMsg of existingMessages) {
            const content = existingMsg.querySelector('.message-content').textContent;
            const time = existingMsg.querySelector('.message-time').textContent;
            if (content === message.content.replace(/<br>/g, '\n') && time === message.created_at) {
                return; // Сообщение уже существует
            }
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${message.author === currentUser ? 'own' : 'other'}`;
        
        messageDiv.innerHTML = `
            <div class="message-author">${message.author}</div>
            <div class="message-content">${message.content.replace(/\n/g, '<br>')}</div>
            <div class="message-time">${message.created_at}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Обработка отправки формы
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const content = messageInput.value.trim();
        if (!content) return;
        
        const teamId = messageForm.dataset.teamId;
        
        fetch('/chat/api/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                content: content,
                team_id: teamId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                messageInput.value = '';
                addMessage(data.message);
            } else {
                alert('Ошибка отправки сообщения: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Ошибка отправки сообщения');
        });
    });
    
    // Функция для получения CSRF токена
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Обновление чата каждые 5 секунд
    setInterval(function() {
        const teamId = chatContainer.dataset.teamId;
        
        fetch(`/chat/api/messages/${teamId}/`)
            .then(response => response.json())
            .then(data => {
                const currentMessages = Array.from(messagesContainer.querySelectorAll('.chat-message'));
                const currentCount = currentMessages.length;
                
                if (data.messages.length > currentCount) {
                    // Добавляем только новые сообщения
                    for (let i = currentCount; i < data.messages.length; i++) {
                        addMessage(data.messages[i]);
                    }
                }
            })
            .catch(error => console.error('Error updating chat:', error));
    }, 5000);
    
    // Фокус на поле ввода
    messageInput.focus();
});
</script>
{% endblock %}
{% endblock %}
